---
- hosts: all
  connection: local
  gather_facts: true
  name: Example Policy Lookup Playbook

  vars:
    provider:
      ip_address: "{{ ansible_host }}"
      username: "{{ lookup('env', 'ANSIBLE_NET_USERNAME') }}"
      password: "{{ lookup('env', 'ANSIBLE_NET_PASSWORD') }}"
    policy_creation_policy_files: []

  tasks:

    - name: Match Web Server to Database Tier
      ansible.builtin.set_fact:
        policy_creation_policy_match: true # Set the fact that we did match a policy
        policy_creation_source_address_group: PRESET_WEB_TO_DATABASE_SOURCE # In this case, the policy preset is an address_group type
        policy_creation_destination_address_group: PRESET_WEB_TO_DATABASE_DESTINATION # Destination addr group
        application_group: PRESET_WEB_TO_DATABASE # If an application is passed, we should also include it in the policy.
        policy_creation_device_group: Lab # Finally, we set the device group!
      when:
        - policy_creation_source_ip is defined
        - policy_creation_destination_ip is defined
        - "policy_creation_source_ip.startswith('10.10.199')"
        - "policy_creation_destination_ip.startswith('10.10.200')"

    - name: Include a role dynamically
      ansible.builtin.include_role:
        name: paloaltonetworks.panos_policy_automation.policy_creation

    - name: Print the results
      ansible.builtin.debug:
        msg: "{{ lookup_policy_security_policy_match_result }}"